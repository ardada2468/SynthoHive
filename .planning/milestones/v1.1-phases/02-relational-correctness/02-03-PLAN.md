---
phase: 02-relational-correctness
plan: "03"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - syntho_hive/relational/linkage.py
  - syntho_hive/relational/orchestrator.py
autonomous: true
requirements:
  - REL-02

must_haves:
  truths:
    - "LinkageModel.fit() no longer uses GaussianMixture — replaced with empirical histogram resampler by default"
    - "LinkageModel accepts method='empirical' (default) or method='negbinom' for per-table cardinality distribution"
    - "NegBinom fitting falls back to empirical with a structlog WARNING when variance <= mean (Poisson regime)"
    - "sample_counts() returns non-negative integer counts — no more negative sample counts from GMM"
    - "max_children attribute is set correctly after fit() for downstream use"
  artifacts:
    - path: "syntho_hive/relational/linkage.py"
      provides: "Empirical + NegBinom cardinality distribution — replaces GaussianMixture"
      contains: "empirical"
  key_links:
    - from: "syntho_hive/relational/orchestrator.py"
      to: "syntho_hive/relational/linkage.py"
      via: "LinkageModel(method=table_config.linkage_method)"
      pattern: "linkage_method"
    - from: "syntho_hive/relational/linkage.py"
      to: "numpy.random.choice"
      via: "empirical resampling from _observed_counts"
      pattern: "_observed_counts"
---

<objective>
Replace the GaussianMixture cardinality model in LinkageModel with an empirical histogram resampler (default) and optional scipy NegBinom distribution, configurable per-table via the linkage_method field added to TableConfig in Plan 01.

Purpose: GaussianMixture produces negative sample counts (it models a continuous distribution, not a discrete count distribution) causing downstream FK integrity failures. The empirical resampler draws directly from observed child counts — guaranteed non-negative, exact distributional match. NegBinom is the standard count distribution for overdispersed data and is already a scipy dependency.

Output: linkage.py rewritten to use empirical (numpy.random.choice) or NegBinom (scipy.stats.nbinom) based on the method parameter. GaussianMixture import removed. Fallback from NegBinom to empirical when distribution is not overdispersed. orchestrator.py updated to pass linkage_method from TableConfig into LinkageModel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-relational-correctness/02-CONTEXT.md
@.planning/phases/02-relational-correctness/02-RESEARCH.md
@syntho_hive/relational/linkage.py
@syntho_hive/relational/orchestrator.py
@syntho_hive/interface/config.py
@.planning/phases/02-relational-correctness/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace GaussianMixture in LinkageModel with empirical/NegBinom distribution</name>
  <files>syntho_hive/relational/linkage.py
syntho_hive/relational/orchestrator.py</files>
  <action>
Read syntho_hive/relational/linkage.py fully (it is ~88 lines). Understand the current structure:
- How __init__ is defined (current GMM parameters)
- How fit() builds the GMM from parent/child DataFrames
- How sample_counts() generates child counts from the GMM
- The silent fallback (except Exception block around lines 36-44) that converts to string — this must be REMOVED

Rewrite the LinkageModel class with the following structure:

### Imports

Remove: `from sklearn.mixture import GaussianMixture`
Keep/add:
```python
import numpy as np
import pandas as pd
import structlog

log = structlog.get_logger()
```

### __init__

```python
def __init__(self, method: str = "empirical"):
    """
    Args:
        method: Cardinality distribution. 'empirical' (default) draws from observed
                child counts. 'negbinom' fits scipy.stats.nbinom via method-of-moments.
                Falls back to empirical if the data is not overdispersed (variance <= mean).
    """
    self.method = method
    self._observed_counts = None
    self._nbinom_n = None
    self._nbinom_p = None
    self.max_children = 0
```

### fit(self, parent_df, child_df, fk_col, pk_col="id")

Count children per parent, merge to get 0 for parents with no children:

```python
def fit(self, parent_df, child_df, fk_col, pk_col="id"):
    counts = child_df[fk_col].value_counts()
    parent_ids = pd.DataFrame(parent_df[pk_col].unique(), columns=[pk_col])
    count_df = parent_ids.merge(
        counts.rename("child_count"),
        left_on=pk_col, right_index=True, how="left"
    ).fillna(0)
    X = count_df["child_count"].to_numpy(dtype=int)
    self.max_children = int(X.max())
    self._observed_counts = X

    if self.method == "negbinom":
        mu = float(X.mean())
        var = float(X.var())
        if var > mu and mu > 0:
            p = mu / var
            n = mu * p / (1.0 - p)
            self._nbinom_n = max(n, 0.1)
            self._nbinom_p = p
        else:
            log.warning(
                "negbinom_fallback_to_empirical",
                reason="variance <= mean or mean is zero — NegBinom ill-defined for this data",
                fk_col=fk_col,
            )
            self.method = "empirical"  # runtime fallback
```

### sample_counts(self, parent_context)

```python
def sample_counts(self, parent_context):
    if self._observed_counts is None:
        raise ValueError("LinkageModel.sample_counts() called before fit()")
    n_samples = len(parent_context)
    if self.method == "negbinom" and self._nbinom_n is not None:
        from scipy import stats
        counts = stats.nbinom.rvs(self._nbinom_n, self._nbinom_p, size=n_samples)
        return np.clip(counts, 0, None).astype(int)
    # Default: empirical — draw from observed distribution
    return np.random.choice(self._observed_counts, size=n_samples, replace=True)
```

### Wire linkage_method from TableConfig into StagedOrchestrator

Read syntho_hive/relational/orchestrator.py to find where LinkageModel is instantiated during fit_all(). Update the instantiation to pass the method from TableConfig:

```python
# Find: linkage_model = LinkageModel()  (or similar)
# Replace with:
linkage_method = self.metadata.tables[table_name].linkage_method
linkage_model = LinkageModel(method=linkage_method)
```

This requires reading the actual instantiation site — it may be in fit_all() or a helper method. Read carefully and update only the instantiation line.

IMPORTANT: Remove the silent `except Exception` fallback block (around current lines 36-44) that converts types to string. This is the anti-pattern called out in RESEARCH.md — it was masking the real FK type mismatch. With REL-03 catching type mismatches at validate_schema() time, this fallback is no longer needed and should be deleted.

IMPORTANT: Do NOT change the method signature of sample_counts() — callers pass parent_context (a DataFrame slice or similar). Keep the `len(parent_context)` call to get the sample size.
  </action>
  <verify>
```bash
cd /Users/arnavdadarya/FedEx/SynthoHive && python -c "
import numpy as np
import pandas as pd
from syntho_hive.relational.linkage import LinkageModel

# Build test data: 5 parents, unequal child counts
parent_df = pd.DataFrame({'id': [1, 2, 3, 4, 5]})
child_df = pd.DataFrame({
    'id': range(12),
    'parent_id': [1, 1, 1, 2, 2, 3, 3, 3, 3, 4, 5, 5]
})

# Test 1: empirical method
model = LinkageModel(method='empirical')
model.fit(parent_df, child_df, fk_col='parent_id', pk_col='id')
assert model._observed_counts is not None
assert model.max_children == 4  # parent 3 has 4 children
counts = model.sample_counts(parent_df)
assert len(counts) == 5
assert all(c >= 0 for c in counts), 'empirical must return non-negative counts'
print('Test 1 PASS: empirical fit and sample_counts work')

# Test 2: all sampled counts are non-negative (core bug fix)
for _ in range(20):
    c = model.sample_counts(parent_df)
    assert min(c) >= 0, f'negative count detected: {c}'
print('Test 2 PASS: no negative counts over 20 samples')

# Test 3: negbinom method with overdispersed data
parent_big = pd.DataFrame({'id': range(50)})
child_big = pd.DataFrame({
    'parent_id': np.repeat(range(50), np.random.poisson(5, 50) + 1)[:200],
    'id': range(200)
})
model_nb = LinkageModel(method='negbinom')
model_nb.fit(parent_big, child_big, fk_col='parent_id', pk_col='id')
# May fall back to empirical if data not overdispersed — that is correct behavior
counts_nb = model_nb.sample_counts(parent_big)
assert len(counts_nb) == 50
assert all(c >= 0 for c in counts_nb)
print(f'Test 3 PASS: negbinom fit (method after fit: {model_nb.method}), counts non-negative')

# Test 4: unfitted model raises ValueError
model_empty = LinkageModel()
try:
    model_empty.sample_counts(parent_df)
    assert False, 'should have raised'
except ValueError:
    print('Test 4 PASS: unfitted model raises ValueError')

print('All LinkageModel tests passed.')
"

# Full test suite
cd /Users/arnavdadarya/FedEx/SynthoHive && python -m pytest tests/ -x --tb=short -q 2>&1 | tail -20
```
  </verify>
  <done>
- GaussianMixture import removed from linkage.py
- LinkageModel.fit() builds _observed_counts from empirical child count histogram
- sample_counts() returns non-negative integers via numpy.random.choice or scipy.stats.nbinom.rvs
- NegBinom falls back to empirical with structlog WARNING when variance <= mean
- Silent except/fallback block removed
- StagedOrchestrator instantiates LinkageModel(method=table_config.linkage_method)
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/arnavdadarya/FedEx/SynthoHive && python -m pytest tests/ -x --tb=short -q 2>&1 | tail -20
```

Confirm GaussianMixture is fully removed:
```bash
grep -n "GaussianMixture" /Users/arnavdadarya/FedEx/SynthoHive/syntho_hive/relational/linkage.py
```
Expected: no output (grep returns nothing).
</verification>

<success_criteria>
- linkage.py uses numpy empirical resampler (default) and scipy.stats.nbinom (opt-in via method='negbinom')
- GaussianMixture import and usage completely removed
- sample_counts() never returns negative values
- NegBinom fallback to empirical works correctly when data is not overdispersed
- Silent fallback except block removed
- StagedOrchestrator passes linkage_method from TableConfig to LinkageModel constructor
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-relational-correctness/02-03-SUMMARY.md`
</output>
