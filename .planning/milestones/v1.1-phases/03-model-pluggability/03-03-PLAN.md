---
phase: 03-model-pluggability
plan: 03
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - pyproject.toml
autonomous: true
requirements:
  - MODEL-03
gap_closure: true

must_haves:
  truths:
    - "Running pytest syntho_hive/tests/test_interface.py -v with no flags produces PASSED for all 4 MODEL-phase tests"
    - "test_stub_model_routes_through_pipeline passes under default pytest invocation"
    - "test_synthesizer_accepts_model_parameter passes under default pytest invocation"
    - "test_synthesizer_default_model_is_ctgan passes under default pytest invocation"
    - "test_issubclass_guard_rejects_invalid_model_cls passes under default pytest invocation"
    - "The 4 pre-existing failures (Spark-environment tests) remain at 4 — no regressions introduced"
  artifacts:
    - path: "pyproject.toml"
      provides: "pytest import mode configuration"
      contains: "importmode = \"importlib\""
  key_links:
    - from: "pyproject.toml"
      to: "syntho_hive/tests/test_interface.py"
      via: "pytest [tool.pytest.ini_options] importmode setting"
      pattern: "importmode.*importlib"
    - from: "syntho_hive/tests/test_interface.py"
      to: "syntho_hive/interface/synthesizer.py"
      via: "import resolution using editable source tree (not stale site-packages)"
      pattern: "from syntho_hive"
---

<objective>
Fix the pytest import mode so the 4 new MODEL-phase tests pass under the default `pytest` invocation without requiring `--import-mode=importlib` as an explicit flag.

Purpose: The VERIFICATION.md identified one gap blocking MODEL-03 from being fully satisfied: a stale site-packages copy of `syntho_hive` at `.venv/lib/python3.14/site-packages/syntho_hive/` shadows the source tree under pytest's default "prepend" import mode. The stale copy predates Phase 03 changes (still has `backend: str`, no `model_cls`). Adding `importmode = "importlib"` to `[tool.pytest.ini_options]` in `pyproject.toml` forces pytest to resolve imports through the editable install finder, which surfaces the current source tree rather than the stale copy. All 4 tests already pass under `--import-mode=importlib`.

Output: Updated `pyproject.toml` with `importmode = "importlib"` in the existing `[tool.pytest.ini_options]` section. MODEL-03 fully satisfied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-model-pluggability/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add importmode = "importlib" to [tool.pytest.ini_options] in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
In `pyproject.toml`, locate the existing `[tool.pytest.ini_options]` section (currently at lines 55-57):

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
```

Add `importmode = "importlib"` as a new line within that section:

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
importmode = "importlib"
```

Why "importlib" mode: Under the default "prepend" mode, pytest prepends the rootdir to `sys.path`, which causes Python to resolve `syntho_hive` from the first matching directory on `sys.path`. A stale non-editable copy exists at `.venv/lib/python3.14/site-packages/syntho_hive/` that predates Phase 03 changes. "importlib" mode uses `importlib.import_module()` to load test modules, which activates the editable install finder (`.pth` file in site-packages) and ensures the source tree copy is loaded instead.

Do NOT change `testpaths` or `python_files` — these are unrelated to the import resolution issue and must remain as they are to avoid breaking any other test discovery behavior.

Do NOT add `--import-mode=importlib` to `addopts` — use the dedicated `importmode` key, which is the correct TOML setting for pytest's importmode configuration.
  </action>
  <verify>
Run from the repo root:

```bash
grep -n "importmode" pyproject.toml
```

Expected: exactly 1 line containing `importmode = "importlib"`.

Then confirm the full section looks correct:

```bash
python -c "
import tomllib
with open('pyproject.toml', 'rb') as f:
    data = tomllib.load(f)
opts = data.get('tool', {}).get('pytest', {}).get('ini_options', {})
print('importmode:', opts.get('importmode'))
print('testpaths:', opts.get('testpaths'))
"
```

Expected output:
```
importmode: importlib
testpaths: ['tests']
```
  </verify>
  <done>
- `pyproject.toml` contains `importmode = "importlib"` under `[tool.pytest.ini_options]`
- All other pytest ini options (`testpaths`, `python_files`) are unchanged
- `tomllib` parse confirms the key is present and set to "importlib"
  </done>
</task>

<task type="auto">
  <name>Task 2: Run the full test_interface.py suite and confirm all 4 MODEL-phase tests pass</name>
  <files></files>
  <action>
Run the full `test_interface.py` suite using the default pytest invocation (no extra flags) to verify that the `importmode` setting resolves the gap:

```bash
.venv/bin/pytest syntho_hive/tests/test_interface.py -v
```

Expected results:
- `test_stub_model_routes_through_pipeline` — PASSED
- `test_synthesizer_accepts_model_parameter` — PASSED
- `test_synthesizer_default_model_is_ctgan` — PASSED
- `test_issubclass_guard_rejects_invalid_model_cls` — PASSED
- `test_synthesizer_fit_requires_spark` — FAILED (pre-existing, unrelated to Phase 03)
- `test_synthesizer_sample_requires_spark` — FAILED (pre-existing, unrelated to Phase 03)
- `test_synthesizer_fit_call` — FAILED (pre-existing, unrelated to Phase 03)
- `test_synthesizer_sample_call` — FAILED (pre-existing, unrelated to Phase 03)

The 4 pre-existing failures are Spark-environment failures documented in 03-01-SUMMARY.md and 03-02-SUMMARY.md — they were present before Phase 03 and are out of scope.

If any of the 4 new MODEL-phase tests still fail after the importmode change, examine the error. If the error is still "unexpected keyword argument" on `backend` or `model_cls`, the stale site-packages copy is still being loaded — in that case, run `pip install -e .` from within `.venv` to overwrite the stale copy, then re-run pytest. Document which resolution path was required in the SUMMARY.

Also run the relational test suite to confirm no regressions:

```bash
.venv/bin/pytest syntho_hive/tests/test_relational.py -v
```

Expected: all tests pass (same as before Plan 03-03).
  </action>
  <verify>
```bash
.venv/bin/pytest syntho_hive/tests/test_interface.py -v 2>&1 | grep -E "PASSED|FAILED|ERROR"
```

Expected lines containing PASSED:
- `test_stub_model_routes_through_pipeline PASSED`
- `test_synthesizer_accepts_model_parameter PASSED`
- `test_synthesizer_default_model_is_ctgan PASSED`
- `test_issubclass_guard_rejects_invalid_model_cls PASSED`

Expected lines containing FAILED (pre-existing only):
- `test_synthesizer_fit_requires_spark FAILED`
- `test_synthesizer_sample_requires_spark FAILED`
- `test_synthesizer_fit_call FAILED`
- `test_synthesizer_sample_call FAILED`

No lines containing ERROR for MODEL-phase tests.
  </verify>
  <done>
- All 4 MODEL-phase tests pass under default `pytest syntho_hive/tests/test_interface.py -v` invocation
- Pre-existing failure count remains at 4 (no regressions)
- test_relational.py suite passes unchanged
- MODEL-03 requirement is fully satisfied: any ConditionalGenerativeModel subclass routes correctly through the multi-table pipeline AND the integration tests prove it under default tooling invocation
  </done>
</task>

</tasks>

<verification>
Full gap closure verification after plan 03-03:

1. grep -n "importmode" pyproject.toml → exactly 1 match: `importmode = "importlib"`
2. .venv/bin/pytest syntho_hive/tests/test_interface.py -v → 4 MODEL-phase tests PASSED, 4 pre-existing FAILED
3. .venv/bin/pytest syntho_hive/tests/test_relational.py -v → all tests PASSED (no regression)
4. MODEL-03 truth verified: "An integration test with StubModel passes — proving MODEL-03 contract end-to-end"
</verification>

<success_criteria>
- pyproject.toml has `importmode = "importlib"` under `[tool.pytest.ini_options]`
- All 4 MODEL-phase tests pass under default `pytest` invocation (no flags required)
- Pre-existing failure count remains at exactly 4 (Spark-environment tests only)
- test_relational.py continues to pass — no regressions
- Phase 03 score advances from 6/7 to 7/7 must-haves verified
- MODEL-03 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-model-pluggability/03-03-SUMMARY.md` with:
- The exact change made to pyproject.toml (before/after diff)
- Full pytest output (paste test_interface.py -v results)
- Whether the importmode change alone resolved the gap, or whether pip install -e . was also required
- Final phase score (should be 7/7)
</output>
